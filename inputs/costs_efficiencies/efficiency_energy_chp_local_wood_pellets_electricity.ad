# Changing efficiency should update electricity output conversion
# Number of units should remain unchanged as total electricity output capacity should remain
# unchanged, since this is a user input
# typical input capacity should be updated to unsure electricity output capacity remains unchanged
# Priority set to 3 to set prior to share in ccs, share of ht/mt and capacity input

- query =
    original_nou_ht_must_run = V(energy_chp_local_ht_wood_pellets_must_run, number_of_units);
    original_nou_ht_dispatchable = V(energy_chp_local_ht_wood_pellets_dispatchable, number_of_units);
    original_nou_mt_must_run = V(energy_chp_local_mt_wood_pellets_must_run, number_of_units);
    original_nou_mt_dispatchable = V(energy_chp_local_mt_wood_pellets_dispatchable, number_of_units);

    start_efficiency_ht_must_run = QUERY_PRESENT(-> {V(energy_chp_local_ht_wood_pellets_must_run, electricity_output_conversion)}) * 100.0;
    start_efficiency_ht_dispatchable = QUERY_PRESENT(-> {V(energy_chp_local_ht_wood_pellets_dispatchable, electricity_output_conversion)}) * 100.0;
    start_efficiency_mt_must_run = QUERY_PRESENT(-> {V(energy_chp_local_mt_wood_pellets_must_run, electricity_output_conversion)}) * 100.0;
    start_efficiency_mt_dispatchable = QUERY_PRESENT(-> {V(energy_chp_local_mt_wood_pellets_dispatchable, electricity_output_conversion)}) * 100.0;

    EACH(
      UPDATE(OUTPUT_SLOTS(V(energy_chp_local_ht_wood_pellets_must_run), electricity), conversion, DIVIDE(USER_INPUT(), 100.0)),
      UPDATE(V(energy_chp_local_ht_wood_pellets_must_run), number_of_units, original_nou_ht_must_run),
      UPDATE(V(energy_chp_local_ht_wood_pellets_must_run), preset_demand_by_electricity_production, V(energy_chp_local_ht_wood_pellets_must_run, production_based_on_number_of_units)),

      UPDATE(OUTPUT_SLOTS(V(energy_chp_local_ht_wood_pellets_dispatchable), electricity), conversion, DIVIDE(USER_INPUT(), 100.0)),
      UPDATE(V(energy_chp_local_ht_wood_pellets_dispatchable), number_of_units, original_nou_ht_dispatchable),
      UPDATE(V(energy_chp_local_ht_wood_pellets_dispatchable), preset_demand_by_electricity_production, V(energy_chp_local_ht_wood_pellets_dispatchable, production_based_on_number_of_units)),

      UPDATE(OUTPUT_SLOTS(V(energy_chp_local_mt_wood_pellets_must_run), electricity), conversion, DIVIDE(USER_INPUT(), 100.0)),
      UPDATE(V(energy_chp_local_mt_wood_pellets_must_run), number_of_units, original_nou_mt_must_run),
      UPDATE(V(energy_chp_local_mt_wood_pellets_must_run), preset_demand_by_electricity_production, V(energy_chp_local_mt_wood_pellets_must_run, production_based_on_number_of_units)),

      UPDATE(OUTPUT_SLOTS(V(energy_chp_local_mt_wood_pellets_dispatchable), electricity), conversion, DIVIDE(USER_INPUT(), 100.0)),
      UPDATE(V(energy_chp_local_mt_wood_pellets_dispatchable), number_of_units, original_nou_mt_dispatchable),
      UPDATE(V(energy_chp_local_mt_wood_pellets_dispatchable), preset_demand_by_electricity_production, V(energy_chp_local_mt_wood_pellets_dispatchable, production_based_on_number_of_units)),

      UPDATE_WITH_FACTOR(
        V(energy_chp_local_ht_wood_pellets_must_run),
        typical_input_capacity,
        DIVIDE(start_efficiency_ht_must_run, USER_INPUT())
      ),
      UPDATE_WITH_FACTOR(
        V(energy_chp_local_ht_wood_pellets_dispatchable),
        typical_input_capacity,
        DIVIDE(start_efficiency_ht_dispatchable, USER_INPUT())
      ),
      UPDATE_WITH_FACTOR(
        V(energy_chp_local_mt_wood_pellets_must_run),
        typical_input_capacity,
        DIVIDE(start_efficiency_mt_must_run, USER_INPUT())
      ),
      UPDATE_WITH_FACTOR(
        V(energy_chp_local_mt_wood_pellets_dispatchable),
        typical_input_capacity,
        DIVIDE(start_efficiency_mt_dispatchable, USER_INPUT())
      )
    )
- priority = 3
- max_value_gql = present:(V(energy_chp_local_ht_wood_pellets_must_run, electricity_output_conversion) * 100.0) + 10.0
- min_value_gql = present:(V(energy_chp_local_ht_wood_pellets_must_run, electricity_output_conversion) * 100.0) - 10.0
- start_value_gql = present:V(energy_chp_local_ht_wood_pellets_must_run, electricity_output_conversion) * 100.0
- step_value = 1.0
- unit = %
- update_period = future
